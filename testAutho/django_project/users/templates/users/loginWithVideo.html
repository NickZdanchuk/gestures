{% extends 'users/base.html' %}

{% block title %}Login{% endblock %}
{%block style %}
<style type="text/css">

#start-record, #stop-record, #download-video {
    display: none;
}

</style>
{% endblock %}

{% block content %}
<h2>Авторизация</h2>


<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="form-error">{{ form.non_field_errors }}</div>

{% for f in form %}
<p><label class="form-label" for="{{ f.id_for_label }}">{{f.label}}: </label>{{ f }}</p>
<div class="form-error">{{ f.errors }}</div>
{% endfor %}
  <button type="submit">Войти</button>


<input type="file" id="myFileInput" name="my_file">



</form>





<p>
    <button id="start-camera">Start Camera</button>
    <video id="video" width="400" height="300" autoplay></video>
    <button id="start-record">Start Recording</button>
    <button id="stop-record">Stop Recording</button>
    <a id="download-video" download="test.webm">Download Video</a>


</p>


<!--
<script src="client.js"></script>
-->

<script>

let camera_button = document.querySelector("#start-camera");
let video = document.querySelector("#video");
let start_button = document.querySelector("#start-record");
let stop_button = document.querySelector("#stop-record");
let download_link = document.querySelector("#download-video");

let camera_stream = null;
let media_recorder = null;
let blobs_recorded = [];

let upload_button = document.querySelector("#Upload");

camera_button.addEventListener('click', async function() {
   	try {
    	camera_stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    }
    catch(error) {
    	alert(error.message);
    	return;
    }

    video.srcObject = camera_stream;
    camera_button.style.display = 'none';
    video.style.display = 'block';
    start_button.style.display = 'block';
});

start_button.addEventListener('click', function() {
    media_recorder = new MediaRecorder(camera_stream, { mimeType: 'video/webm' });

    media_recorder.addEventListener('dataavailable', function(e) {
    	blobs_recorded.push(e.data);
    });

    media_recorder.addEventListener('stop', function() {
    	let video_local = URL.createObjectURL(new Blob(blobs_recorded, { type: 'video/webm' }));
    	download_link.href = video_local;

    	let recording = new File(blobs_recorded, 'recording.webm', { type: 'video/webm' });
        let data = new FormData();
        data.append('file', recording);



        let response = await fetch('/loginWithVideo.html', {
        method: 'PUT',
        body: data
        });



        const file = new File(blobs_recorded, 'recording.webm', { type: 'video/webm' });
        const fileInput = document.getElementById("myFileInput");
        fileInput.files[0] = file;
        document.getElementById("myFileInput").files[0] = recording;





        stop_button.style.display = 'none';
        download_link.style.display = 'block';


    });

    media_recorder.start(1000);

    start_button.style.display = 'none';
    stop_button.style.display = 'block';
});

stop_button.addEventListener('click', function() {
	media_recorder.stop();
});









</script>

<!--
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Авторизироваться</button>
</form>
-->

{% endblock %}

